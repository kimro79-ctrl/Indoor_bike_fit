name: BikeFit - ABSOLUTE REBUILD SUCCESS

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: â˜• Java 17 ë° Flutter ì„¤ì • (3.27.1)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ¦ Flutter ì„¤ì •
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'

      - name: ğŸ—ï¸ [ê·¼ë³¸ ëŒ€ì±…] Android ì—”ì§„ ì™„ì „ ì¬ê±´ì¶• (V2 ê°•ì œ ì „í™˜)
        run: |
          # 1. ì¢€ë¹„ ì„¤ì •ì´ ë‚¨ì€ ê¸°ì¡´ android í´ë” ì‚­ì œ
          rm -rf android/
          
          # 2. í˜„ì¬ í”ŒëŸ¬í„° ë²„ì „ í‘œì¤€ìœ¼ë¡œ ì•ˆë“œë¡œì´ë“œ í”„ë¡œì íŠ¸ ì‹ ê·œ ìƒì„±
          # íŒ¨í‚¤ì§€ëª…: com.overthebike.over_the_bike_fit
          flutter create . --platforms=android --org com.overthebike --project-name over_the_bike_fit
          
          # 3. [ì‚¬ìš©ìë‹˜ ì œì•ˆ ë°˜ì˜] V2 ì„ë² ë”© ë©”íƒ€ë°ì´í„° ê°•ì œ ì£¼ì…
          sed -i '/<application/a \        <meta-data android:name="flutterEmbedding" android:value="2" />' android/app/src/main/AndroidManifest.xml
          
          # 4. ì˜ì¡´ì„± ìƒˆë¡œê³ ì¹¨
          flutter pub get

      - name: ğŸ”‘ [ì„±ê³µ] í‚¤ìŠ¤í† ì–´ ë° ì„œëª… ì„¤ì • (ë£¨íŠ¸ JKS í™œìš©)
        run: |
          # ë£¨íŠ¸ì— ìˆëŠ” release.jksë¥¼ ìƒˆë¡œ ë§Œë“  í´ë”ë¡œ ì´ë™
          cp release.jks android/app/release.jks
          
          cat <<EOF > android/app/key.properties
          storePassword=Sodomaki80
          keyPassword=Sodomaki80
          keyAlias=fresh-upload-key
          storeFile=release.jks
          EOF

      - name: ğŸš€ [í•„ì‚´ê¸°] AAB ë¹Œë“œ (V1 ì²´í¬ ì™„ì „ ë¬´ë ¥í™”)
        run: |
          # ë¹Œë“œ ì—”ì§„ì´ êµ¬í˜• íŒŒì¼ì„ ë§Œë“¤ í‹ˆì„ ì£¼ì§€ ì•Šê¸° ìœ„í•´ --no-pub ì‚¬ìš©
          flutter build appbundle --release --no-tree-shake-icons --no-pub

      - name: ğŸ“¦ [ì™„ë£Œ] AAB ê²°ê³¼ë¬¼ ì¶”ì¶œ
        uses: actions/upload-artifact@v4
        with:
          name: BikeFit_Perfect_V2_AAB
          path: |
            build/app/outputs/bundle/release/*.aab
            build/**/*.aab
          if-no-files-found: error
