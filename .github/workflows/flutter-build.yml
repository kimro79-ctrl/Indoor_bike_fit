name: BikeFit Ultimate Fix - Force Signing 2026
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java & Flutter
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'

      - name: Force Clean & Force Signing Config Override
        run: |
          flutter clean
          rm -rf $HOME/.gradle $HOME/.pub-cache android/.gradle android/app/build android/app/.gradle

          flutter pub cache repair
          flutter pub get

          flutter create . --platforms android --overwrite

          mkdir -p android/app
          cp release.jks android/app/release.jks || exit 1

          cat <<EOF > android/key.properties
          storePassword=Sodomaki80
          keyPassword=Sodomaki80
          keyAlias=fresh-upload-key
          storeFile=release.jks
          EOF

          # signingConfigs 전체 삭제 후 새로 삽입 (fallback 방지 최강)
          sed -i '/signingConfigs {/,/}/d' android/app/build.gradle || true
          sed -i '/android {/a \
          signingConfigs {\
              release {\
                  storeFile file("release.jks")\
                  storePassword "Sodomaki80"\
                  keyAlias "fresh-upload-key"\
                  keyPassword "Sodomaki80"\
              }\
          }' android/app/build.gradle

          sed -i '/buildTypes {/a \        signingConfig signingConfigs.release' android/app/build.gradle

          # 로그로 확인
          echo "key.properties:"
          cat android/key.properties
          echo "build.gradle signing:"
          grep -A 40 signingConfigs android/app/build.gradle

      - name: Build AAB with Verbose
        run: flutter build appbundle --release --no-tree-shake-icons --verbose > build_log.txt 2>&1 && grep -i "signing\|alias\|keystore\|validateSigning\|fresh" build_log.txt

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: BikeFit_Ultimate_AAB
          path: build/app/outputs/bundle/release/app-release.aab

      - name: Upload Logs (Always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Build_Debug_Logs
          path: build_log.txt
