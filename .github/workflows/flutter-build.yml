name: BikeFit Final Success
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java & Flutter
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'

      - name: ğŸ” ì„œëª… ì •ë³´ ê°•ì œ ì£¼ì… (ë³€ìˆ˜ ì—†ì´ ì§ì ‘ ì…ë ¥)
        run: |
          # 1. ì•ˆë“œë¡œì´ë“œ êµ¬ì¡° ìµœì‹ í™”
          flutter create . --platforms android --overwrite

          # 2. ë£¨íŠ¸ì˜ release.jksë¥¼ ì•± í´ë”ë¡œ ë³µì‚¬
          mkdir -p android/app
          cp release.jks android/app/release.jks

          # 3. [í•µì‹¬] ë¹Œë“œ ì„¤ì • íŒŒì¼ì— ì„œëª… ì •ë³´ë¥¼ í…ìŠ¤íŠ¸ë¡œ ì§ì ‘ ë°•ìŒ
          # ì‹œìŠ¤í…œì´ ìë™ìœ¼ë¡œ í‚¤ë¥¼ ì°¾ëŠ” ê³¼ì •ì„ ìƒëµí•˜ê³  ì´ ì •ë³´ë¥¼ ê°•ì œë¡œ ì“°ê²Œ í•©ë‹ˆë‹¤.
          cat <<EOF > android/app/build.gradle
          plugins {
              id "com.android.application"
              id "kotlin-android"
              id "dev.flutter.flutter-gradle-plugin"
          }

          android {
              namespace "com.overthebike.over_the_bike_fit"
              compileSdk 34

              signingConfigs {
                  release {
                      storeFile file("release.jks")
                      storePassword "Sodomaki80"
                      keyAlias "fresh-upload-key"
                      keyPassword "Sodomaki80"
                  }
              }

              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                  }
              }
          }
          EOF

          flutter pub get

      - name: AAB ë¹Œë“œ ì‹¤í–‰
        run: flutter build appbundle --release --no-tree-shake-icons

      - name: â˜…ìµœì¢… íŒŒì¼ ë‹¤ìš´ë¡œë“œâ˜…
        uses: actions/upload-artifact@v4
        with:
          name: BikeFit_FINAL_AAB
          path: build/app/outputs/bundle/release/app-release.aab
